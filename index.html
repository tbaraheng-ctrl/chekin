<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบบันทึกเวลาเรียน</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* ซ่อน Scrollbar แต่ยังเลื่อนได้ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* อนิเมชันสำหรับ Alert */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex justify-center">

    <div class="bg-gray-50 w-full max-w-md shadow-xl flex flex-col relative h-screen overflow-hidden">
        
        <!-- Header -->
        <header class="bg-indigo-600 text-white p-4 shadow-md z-10">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold">ระบบบันทึกเวลาเรียน</h1>
                    <p class="text-indigo-200 text-sm">ครูเวร: สมศรี รักการสอน (ประตู 1)</p>
                </div>
                <i class="fa-regular fa-clock text-2xl text-indigo-200"></i>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto pb-20 no-scrollbar relative" id="main-content">
            
            <!-- Dashboard Stats -->
            <div class="bg-white p-4 flex gap-4 border-b border-gray-200 sticky top-0 z-10">
                <div class="flex-1 bg-green-50 rounded-lg p-3 border border-green-100 flex items-center gap-3 shadow-sm">
                    <div class="bg-green-500 p-2 rounded-full text-white w-10 h-10 flex items-center justify-center">
                        <i class="fa-solid fa-user-check"></i>
                    </div>
                    <div>
                        <p class="text-xs text-green-600 font-semibold">เข้าเรียนแล้ว</p>
                        <p class="text-xl font-bold text-green-700" id="stat-present">0 <span class="text-sm font-normal">คน</span></p>
                    </div>
                </div>
                <div class="flex-1 bg-gray-50 rounded-lg p-3 border border-gray-100 flex items-center gap-3 shadow-sm">
                    <div class="bg-gray-400 p-2 rounded-full text-white w-10 h-10 flex items-center justify-center">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 font-semibold">ยอดรวม</p>
                        <p class="text-xl font-bold text-gray-700" id="stat-total">5 <span class="text-sm font-normal">คน</span></p>
                    </div>
                </div>
            </div>

            <!-- TAB: SCAN -->
            <div id="tab-scan" class="p-4 flex flex-col items-center">
                
                <!-- Method Selector -->
                <div class="flex bg-gray-200 rounded-lg p-1 mb-4 w-full max-w-xs relative">
                    <button onclick="setScanMethod('fingerprint')" id="btn-method-finger" class="flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors bg-white shadow text-indigo-600">
                        <i class="fa-solid fa-fingerprint"></i> สแกนนิ้วภายนอก
                    </button>
                    <button onclick="setScanMethod('qr')" id="btn-method-qr" class="flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors text-gray-500 hover:text-gray-700">
                        <i class="fa-solid fa-qrcode"></i> กล้อง/QR Code
                    </button>
                </div>

                <!-- SCAN AREA -->
                <div class="bg-white w-full rounded-2xl shadow-sm border border-gray-200 overflow-hidden relative min-h-[300px] flex flex-col items-center justify-center p-4">
                    
                    <!-- QR Reader Container -->
                    <div id="qr-reader" class="w-full hidden"></div>
                    
                    <!-- External Scanner Input (Hidden input waiting for USB scanner) -->
                    <div id="fingerprint-area" class="w-full flex flex-col items-center text-center">
                        <div class="w-24 h-24 rounded-full bg-indigo-50 border-4 border-indigo-100 flex items-center justify-center mb-4 text-indigo-400">
                            <i class="fa-solid fa-fingerprint text-5xl"></i>
                        </div>
                        <p class="text-gray-600 font-medium mb-2">เชื่อมต่อเครื่องสแกนนิ้ว USB แล้ว</p>
                        <p class="text-sm text-gray-400 mb-4">ให้นักเรียนทาบนิ้วที่เครื่องอ่าน<br>(หรือพิมพ์รหัสเพื่อทดสอบ)</p>
                        
                        <!-- ช่องรับค่าจากเครื่องสแกนนิ้วแบบ USB (ทำหน้าที่เหมือนคีย์บอร์ด) -->
                        <input type="text" id="manual-id-input" placeholder="พิมพ์รหัสนักเรียน (เช่น 66001)" 
                               class="border border-gray-300 rounded-lg px-4 py-2 text-center w-4/5 focus:ring-2 focus:ring-indigo-500 focus:outline-none"
                               autocomplete="off">
                    </div>

                </div>

                <!-- Alert Result (Dynamic) -->
                <div id="scan-alert" class="hidden mt-4 w-full p-4 rounded-xl border flex items-start gap-4 animate-slide-up bg-white shadow-sm">
                    <div id="alert-icon-container" class="p-2 rounded-full text-white bg-green-500 w-10 h-10 flex items-center justify-center shrink-0">
                        <i id="alert-icon" class="fa-solid fa-check"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h3 id="alert-title" class="font-bold text-green-800">บันทึกสำเร็จ</h3>
                            <span id="alert-time" class="text-xs font-semibold text-gray-500 mt-1">08:00</span>
                        </div>
                        <p id="alert-name" class="text-gray-800 font-medium mt-1">ชื่อ-สกุล</p>
                        <p id="alert-desc" class="text-sm text-gray-500">รายละเอียด</p>
                    </div>
                </div>

            </div>

            <!-- TAB: HISTORY -->
            <div id="tab-history" class="p-4 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-clock-rotate-left"></i> ประวัติวันนี้
                    </h2>
                    <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-700 bg-red-50 px-2 py-1 rounded">ล้างข้อมูล</button>
                </div>
                
                <div id="history-container" class="space-y-3">
                    <!-- Logs will be generated here -->
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-white border-t border-gray-200 flex absolute bottom-0 w-full z-20 pb-safe">
            <button onclick="switchTab('scan')" id="nav-scan" class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-indigo-600 transition-colors">
                <i class="fa-solid fa-expand text-xl"></i>
                <span class="text-[10px] font-medium">สแกน</span>
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="flex-1 py-3 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-gray-600 transition-colors">
                <i class="fa-solid fa-list text-xl"></i>
                <span class="text-[10px] font-medium">ประวัติ</span>
            </button>
        </nav>
    </div>

    <script>
        // 1. ฐานข้อมูลนักเรียนจำลอง (ในระบบจริงดึงจาก API)
        const studentsDb = [
            { id: '66001', name: 'ด.ช. สมชาย รักดี', class: 'ม.1/1' },
            { id: '66002', name: 'ด.ญ. สมหญิง ใจงาม', class: 'ม.1/1' },
            { id: '66003', name: 'นาย มานะ อดทน', class: 'ม.4/2' },
            { id: '66004', name: 'นางสาว ปิติ ยินดี', class: 'ม.5/1' },
            { id: '66005', name: 'ด.ช. ชูใจ ไชโย', class: 'ม.2/3' },
        ];

        // 2. ตัวแปรสถานะ
        let logs = JSON.parse(localStorage.getItem('attendanceLogs')) || [];
        let html5QrcodeScanner = null;
        let isProcessing = false; // ป้องกันสแกนรัวๆ

        // อัพเดทจำนวนนักเรียนทั้งหมด
        document.getElementById('stat-total').innerHTML = `${studentsDb.length} <span class="text-sm font-normal">คน</span>`;

        // 3. เริ่มต้นการทำงาน
        window.onload = () => {
            updateDashboard();
            renderLogs();
            
            // ดักจับการกด Enter ในช่องกรอกรหัส (สำหรับเครื่องสแกนนิ้ว USB)
            const inputField = document.getElementById('manual-id-input');
            inputField.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    const studentId = this.value.trim();
                    if(studentId) {
                        processScan(studentId);
                        this.value = ''; // เคลียร์ช่อง
                    }
                }
            });
            inputField.focus(); // ให้พร้อมรับค่าทันที
        };

        // 4. สลับ Method การสแกน
        function setScanMethod(method) {
            const btnFinger = document.getElementById('btn-method-finger');
            const btnQr = document.getElementById('btn-method-qr');
            const areaFinger = document.getElementById('fingerprint-area');
            const areaQr = document.getElementById('qr-reader');

            hideAlert();

            if (method === 'fingerprint') {
                // UI changes
                btnFinger.className = "flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors bg-white shadow text-indigo-600";
                btnQr.className = "flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors text-gray-500 hover:text-gray-700";
                areaFinger.classList.remove('hidden');
                areaQr.classList.add('hidden');
                
                // Stop QR Scanner
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear().catch(err => console.error("Failed to clear scanner", err));
                    html5QrcodeScanner = null;
                }
                
                setTimeout(() => document.getElementById('manual-id-input').focus(), 100);

            } else {
                // UI changes
                btnQr.className = "flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors bg-white shadow text-indigo-600";
                btnFinger.className = "flex-1 py-2 text-sm font-medium rounded-md flex items-center justify-center gap-2 transition-colors text-gray-500 hover:text-gray-700";
                areaQr.classList.remove('hidden');
                areaFinger.classList.add('hidden');

                // Start QR Scanner
                if (!html5QrcodeScanner) {
                    html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: {width: 250, height: 250}, aspectRatio: 1.0 });
                    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
                }
            }
        }

        // 5. เมื่อสแกน QR Code สำเร็จ
        function onScanSuccess(decodedText, decodedResult) {
            if (isProcessing) return; // กำลังประมวลผล ให้ข้ามไป
            
            // ปกติ QR Code อาจจะมี URL ด้วย เราต้องกรองเอารหัสมา (สมมติว่าเป็นข้อความรหัสตรงๆ เช่น "66001")
            const studentId = decodedText.trim();
            processScan(studentId);
            
            // หยุดสแกน 2 วินาทีเพื่อไม่ให้รัว
            isProcessing = true;
            setTimeout(() => { isProcessing = false; }, 2000);
        }

        function onScanFailure(error) {
            // ไม่ต้องทำอะไร ปล่อยให้มันหาต่อไป
        }

        // 6. ประมวลผลข้อมูลนักเรียน
        function processScan(studentId) {
            const student = studentsDb.find(s => s.id === studentId);
            
            if (!student) {
                showAlert('error', 'ไม่พบข้อมูลนักเรียน', `รหัส: ${studentId}`, 'โปรดตรวจสอบรหัส หรือติดต่องานทะเบียน');
                playAudio('error');
                return;
            }

            // เช็คว่าวันนี้สแกนเข้าหรือยัง
            const todayStr = new Date().toDateString();
            const studentLogsToday = logs.filter(l => l.studentId === studentId && new Date(l.timestamp).toDateString() === todayStr);
            
            let scanType = 'in'; // ค่าเริ่มต้นคือเข้าเรียน
            
            if (studentLogsToday.length === 1 && studentLogsToday[0].type === 'in') {
                scanType = 'out'; // ถ้าเคยเข้าแล้ว แสดงว่าสแกนออก
            } else if (studentLogsToday.length >= 2) {
                showAlert('error', 'สแกนซ้ำ', student.name, 'นักเรียนได้สแกนเข้าและออกไปแล้วในวันนี้');
                playAudio('error');
                return;
            }

            // สร้าง Record ใหม่
            const now = new Date();
            const timeStr = now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            const newLog = {
                id: Date.now(),
                studentId: student.id,
                name: student.name,
                class: student.class,
                time: timeStr,
                timestamp: now.toISOString(),
                type: scanType
            };

            // บันทึก
            logs.unshift(newLog); // เอาไว้บนสุด
            localStorage.setItem('attendanceLogs', JSON.stringify(logs));
            
            // อัพเดทหน้าจอ
            updateDashboard();
            renderLogs();
            
            // แสดงผล
            const title = scanType === 'in' ? 'บันทึกเข้าเรียนสำเร็จ' : 'บันทึกกลับบ้านสำเร็จ';
            showAlert(scanType, title, student.name, `รหัส: ${student.id} | ชั้น: ${student.class}`, timeStr);
            playAudio('success');
        }

        // 7. จัดการ Alert UI
        function showAlert(type, title, name, desc, time = '') {
            const alertBox = document.getElementById('scan-alert');
            const iconContainer = document.getElementById('alert-icon-container');
            const icon = document.getElementById('alert-icon');
            
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-name').innerText = name;
            document.getElementById('alert-desc').innerText = desc;
            document.getElementById('alert-time').innerText = time;

            alertBox.classList.remove('hidden');
            
            // รีเซ็ตคลาส
            alertBox.className = "mt-4 w-full p-4 rounded-xl border flex items-start gap-4 animate-slide-up bg-white shadow-sm";
            iconContainer.className = "p-2 rounded-full text-white w-10 h-10 flex items-center justify-center shrink-0";

            if (type === 'in') {
                alertBox.classList.add('border-green-200', 'bg-green-50');
                iconContainer.classList.add('bg-green-500');
                icon.className = "fa-solid fa-user-check";
                document.getElementById('alert-title').className = "font-bold text-green-800";
            } else if (type === 'out') {
                alertBox.classList.add('border-blue-200', 'bg-blue-50');
                iconContainer.classList.add('bg-blue-500');
                icon.className = "fa-solid fa-user-minus";
                document.getElementById('alert-title').className = "font-bold text-blue-800";
            } else {
                alertBox.classList.add('border-red-200', 'bg-red-50');
                iconContainer.classList.add('bg-red-500');
                icon.className = "fa-solid fa-triangle-exclamation";
                document.getElementById('alert-title').className = "font-bold text-red-800";
            }
        }

        function hideAlert() {
            document.getElementById('scan-alert').classList.add('hidden');
        }

        // 8. อัพเดทตัวเลข Dashboard
        function updateDashboard() {
            const todayStr = new Date().toDateString();
            // นับคนที่สแกน 'in' ในวันนี้
            const presentCount = new Set(logs.filter(l => l.type === 'in' && new Date(l.timestamp).toDateString() === todayStr).map(l => l.studentId)).size;
            document.getElementById('stat-present').innerHTML = `${presentCount} <span class="text-sm font-normal">คน</span>`;
        }

        // 9. วาดประวัติ
        function renderLogs() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';

            const todayStr = new Date().toDateString();
            const todayLogs = logs.filter(l => new Date(l.timestamp).toDateString() === todayStr);

            if (todayLogs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10 text-gray-400">
                        <i class="fa-solid fa-clock-rotate-left text-5xl mb-3 opacity-20"></i>
                        <p>ยังไม่มีประวัติการสแกนในวันนี้</p>
                    </div>`;
                return;
            }

            todayLogs.forEach(log => {
                const colorTheme = log.type === 'in' ? 'green' : 'blue';
                const typeText = log.type === 'in' ? 'เข้า' : 'ออก';
                
                const logEl = document.createElement('div');
                logEl.className = "bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex items-center justify-between";
                logEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-1.5 h-10 rounded-full bg-${colorTheme}-400"></div>
                        <div>
                            <p class="font-medium text-gray-800 text-sm">${log.name}</p>
                            <p class="text-xs text-gray-500">${log.class} | ${log.studentId}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] font-bold px-2 py-1 rounded-full bg-${colorTheme}-100 text-${colorTheme}-700">
                            ${typeText}
                        </span>
                        <p class="text-xs text-gray-400 mt-1">${log.time}</p>
                    </div>
                `;
                container.appendChild(logEl);
            });
        }

        // 10. สลับหน้าจอ สแกน / ประวัติ
        function switchTab(tab) {
            const tabScan = document.getElementById('tab-scan');
            const tabHistory = document.getElementById('tab-history');
            const navScan = document.getElementById('nav-scan');
            const navHistory = document.getElementById('nav-history');

            if (tab === 'scan') {
                tabScan.classList.remove('hidden');
                tabHistory.classList.add('hidden');
                navScan.className = "flex-1 py-3 flex flex-col items-center justify-center gap-1 text-indigo-600 transition-colors";
                navHistory.className = "flex-1 py-3 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-gray-600 transition-colors";
                
                // โฟกัสช่องกรอกอัตโนมัติเผื่อใช้เครื่องสแกนนิ้ว
                if(!document.getElementById('fingerprint-area').classList.contains('hidden')) {
                    document.getElementById('manual-id-input').focus();
                }

            } else {
                tabScan.classList.add('hidden');
                tabHistory.classList.remove('hidden');
                navHistory.className = "flex-1 py-3 flex flex-col items-center justify-center gap-1 text-indigo-600 transition-colors";
                navScan.className = "flex-1 py-3 flex flex-col items-center justify-center gap-1 text-gray-400 hover:text-gray-600 transition-colors";
            }
        }

        function clearHistory() {
            if(confirm('คุณต้องการล้างประวัติการสแกนของวันนี้ทั้งหมดใช่หรือไม่?')) {
                logs = [];
                localStorage.removeItem('attendanceLogs');
                updateDashboard();
                renderLogs();
            }
        }

        // จำลองเสียงตี๊ด
        function playAudio(type) {
            // ในระบบจริงสามารถใส่ไฟล์ MP3 ได้
            // const audio = new Audio(type === 'success' ? 'success.mp3' : 'error.mp3');
            // audio.play();
        }

    </script>
</body>
</html>
